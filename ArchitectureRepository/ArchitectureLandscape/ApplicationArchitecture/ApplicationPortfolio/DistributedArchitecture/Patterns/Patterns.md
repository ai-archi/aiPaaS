# Distributed Architecture Patterns

## 1. 系统级架构模式

### 1.1 微服务模式
- **定义**：将应用拆分为小型自治服务，每个服务独立部署和扩展。
- **优点**：灵活、易扩展、团队自治。
- **缺点**：增加分布式复杂性，跨服务事务难以管理。
- **使用场景**：中大型互联网应用、复杂业务系统。

### 1.2 事件驱动模式
- **定义**：系统通过事件或消息异步触发操作，实现服务解耦。
- **优点**：高吞吐量、服务解耦。
- **缺点**：调试复杂，需处理顺序和幂等性。
- **使用场景**：订单处理、库存管理、通知系统。

### 1.3 CQRS（Command Query Responsibility Segregation）
- **定义**：读操作和写操作分离，使用不同的数据模型或存储策略。
- **优点**：优化性能，支持复杂查询。
- **缺点**：增加系统复杂性，需事件驱动保持数据一致。
- **使用场景**：高性能读写分离、复杂业务查询。

### 1.4 Saga 模式
- **定义**：分布式事务通过一系列局部事务和补偿操作实现最终一致性。
- **优点**：支持微服务架构，避免全局锁。
- **缺点**：补偿逻辑复杂。
- **使用场景**：电商订单、支付和库存操作。

### 1.5 TCC（Try-Confirm-Cancel）
- **定义**：分布式事务三步执行：尝试（Try）、确认（Confirm）、取消（Cancel）。
- **优点**：关键业务事务提供精确控制。
- **缺点**：实现复杂，需补偿操作。
- **使用场景**：支付系统、跨服务库存扣减。

### 1.6 服务网格模式（Service Mesh）
- **定义**：通过代理（Envoy）和控制面（Istio）统一管理服务通信。
- **优点**：提供服务发现、流量管理、熔断、监控。
- **缺点**：运维复杂度高。
- **使用场景**：大规模微服务集群，需要统一流量管理和安全策略。

### 1.7 全局/跨数据中心负载均衡
- **定义**：跨集群或跨区域的流量分发。
- **技术**：DNS、GTM、云负载均衡。
- **使用场景**：跨区域高可用服务部署。

---

## 2. 服务级微服务模式

### 2.1 客户端负载均衡
- **定义**：服务调用方通过注册中心选择目标服务实例。
- **工具**：Ribbon、Feign、gRPC
- **使用场景**：微服务调用频繁、需要动态实例选择。

### 2.2 服务端负载均衡
- **定义**：统一入口分发请求到后端服务实例。
- **工具**：Nginx、HAProxy、Spring Cloud Gateway
- **使用场景**：集中控制流量，跨服务访问统一入口。

### 2.3 容错模式
- **重试（Retry）**：请求失败后自动重试。
- **熔断（Circuit Breaker）**：服务失败达到阈值时短路，防止雪崩。
- **限流（Rate Limiting）**：控制请求频率。
- **故障转移（Failover）**：主服务失败切换到备用服务。
- **使用场景**：微服务调用、外部接口集成。

### 2.4 API 版本控制
- **模式**：URI 版本、请求头版本、参数版本。
- **使用场景**：多版本并存，避免破坏已有客户端。
- **注意事项**：尽量保持向后兼容，兼容 gRPC 可通过多实例或独立端口。

### 2.5 配置管理
- **定义**：集中管理微服务配置。
- **工具**：Spring Cloud Config、Nacos
- **使用场景**：动态配置、环境差异配置。

### 2.6 可观测性 / 监控
- **指标**：延迟、吞吐量、错误率、健康检查。
- **工具**：Prometheus、Grafana、Zipkin、Jaeger
- **使用场景**：系统调优、故障排查、服务依赖分析。

---

## 3. 技术实现示例

| 工具 / 框架 | 类型 | 功能 |
|------------|------|------|
| Netflix OSS | 微服务框架 | Eureka、Ribbon、Hystrix、Zuul |
| Spring Cloud | 微服务框架 | 服务注册、客户端负载均衡、配置管理、熔断 |
| Spring Cloud Alibaba | 微服务框架 | Nacos、Sentinel、Dubbo、Seata、RocketMQ |
| Istio / Envoy | 服务网格 | 流量管理、熔断、重试、可观测性 |
| Kafka / RabbitMQ / RocketMQ | 消息中间件 | 异步通信、事件驱动、解耦 |

---

## 4. 实践注意事项
- 系统级模式适合整体架构设计，服务级模式适合单服务或服务间治理。
- 异步模式需处理顺序、幂等和补偿逻辑。
- 负载均衡和容错模式需结合监控和告警机制。
- 服务网格和消息中间件需评估性能和运维开销。
