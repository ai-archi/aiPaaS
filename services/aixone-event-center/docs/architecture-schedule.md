# 分布式调度中心设计方案（指导研发）

## 1. 设计目标

1. **任务调度与执行分离**

   * 调度中心只负责任务调度、触发、记录状态。
   * 执行微服务负责业务逻辑执行。
2. **支持多类型任务调度**

   * 定时任务（Cron 表达式）
   * 一次性任务（按时间点触发）
   * 可动态添加、删除、暂停、恢复任务
3. **高可用与可扩展**

   * 调度中心采用集群模式，保证节点故障时任务不丢失。
   * 执行微服务可水平扩展，处理任务并发能力可调。
4. **任务状态统一管理与监控**

   * 调度中心记录任务状态：待执行、执行中、执行成功、执行失败。
   * 提供任务执行结果查询与监控接口。

---

## 2. 架构概览

```
+--------------------+       +-------------------+       +-------------------+
| 调度中心服务       | ----> | 消息队列 / 调用接口| ----> | 执行微服务1       |
| - Quartz集群       |       |                   |       | 执行业务逻辑      |
| - 任务元数据管理   |       |                   |       |                   |
| - 状态记录         |       |                   |       | 执行微服务2       |
+--------------------+       +-------------------+       +-------------------+
        ^                                                   ^
        |                                                   |
        +------------ 状态回调 / 执行结果 ------------------+
```

### 模块职责

| 模块        | 职责                                             |
| --------- | ---------------------------------------------- |
| **调度中心**  | 任务元数据管理、触发任务、记录任务状态、提供任务管理接口                   |
| **执行微服务** | 接收任务、执行业务逻辑、上报执行结果，保证幂等性                       |
| **通信组件**  | 消息队列（Kafka/RabbitMQ）或 HTTP/gRPC 调用，承载任务消息和执行结果 |
| **监控系统**  | 可视化任务执行情况，包括成功率、失败率、延迟等指标                      |

---

## 3. 核心设计要点

### 3.1 调度机制

* 使用 **Quartz 集群**实现任务调度：

  * 所有调度节点共享数据库存储任务元数据。
  * 集群节点会通过数据库锁保证任务只执行一次。
* 支持：

  * **定时任务**（Cron 表达式）
  * **一次性任务**（指定触发时间）
  * **动态任务管理**（添加、删除、暂停、恢复）

### 3.2 任务执行方式

* 调度中心触发任务后，将任务信息发送到执行微服务：

  * **通过消息队列**：MQ 作为异步通信通道，支持高并发、负载均衡。
  * **通过 HTTP/gRPC 调用**：同步方式，适合低延迟需求。
* 执行微服务负责执行业务逻辑，并保证任务幂等。

### 3.3 任务状态管理

* 调度中心统一维护任务执行状态：

  * 待执行（PENDING）
  * 执行中（RUNNING）
  * 执行成功（SUCCESS）
  * 执行失败（FAIL）
* 执行微服务完成任务后，通过回调或消息通知调度中心。
* 调度中心更新状态并记录：

  * 执行时间、耗时、执行结果、异常信息
  * 支持重试和失败告警

### 3.4 高可用与扩展

* **调度中心**：

  * Quartz 集群 + 数据库，保证单节点故障不影响整体调度。
* **执行微服务**：

  * 多实例部署，可水平扩展。
  * 使用消息队列或负载均衡分配任务。
* **容错机制**：

  * 任务执行失败可重试。
  * 执行微服务异常时，调度中心可重新分配任务。

### 3.5 监控与运维

* 调度中心提供任务状态查询接口：

  * 单任务状态查询
  * 执行历史记录查询
* 任务统计与告警：

  * 成功率、失败率、平均执行时间
  * 失败任务可自动重试或告警

---

## 4. 数据结构设计（逻辑概览）

| 实体                  | 核心字段                                      | 描述             |
| ------------------- | ----------------------------------------- | -------------- |
| **任务(Task)**        | 任务ID、任务名称、任务类型、调度策略、状态、执行次数、上次执行时间、下次执行时间 | 存储任务元数据和调度策略   |
| **任务执行记录(TaskLog)** | 记录ID、任务ID、执行节点、开始时间、结束时间、状态、异常信息          | 记录每次任务执行结果     |
| **执行微服务注册表**（可选）    | 服务ID、服务类型、可处理任务类型、健康状态                    | 支持任务分发到合适微服务实例 |

---

## 5. 工作流程概览

1. **任务注册**

   * 运维人员或系统通过调度中心管理界面创建任务。
   * 任务信息写入数据库，Quartz 触发器准备就绪。

2. **任务触发**

   * Quartz 根据调度策略触发任务。
   * 调度中心生成任务执行消息或调用接口发送给执行微服务。

3. **任务执行**

   * 执行微服务接收任务。
   * 执行业务逻辑，保证幂等性。
   * 执行完成后通过回调或 MQ 通知调度中心。

4. **状态更新与监控**

   * 调度中心记录任务执行结果（成功/失败/异常信息）。
   * 提供查询接口和告警机制。

---

## 6. 技术选型建议

| 功能     | 技术选型                             |
| ------ | -------------------------------- |
| 分布式调度  | Quartz 集群                        |
| 任务执行通知 | 消息队列（Kafka/RabbitMQ） 或 HTTP/gRPC |
| 分布式锁   | Quartz 自带数据库锁或 Redis/Etcd        |
| 状态存储   | 关系型数据库（MySQL/PostgreSQL）         |
| 监控     | Prometheus + Grafana 或内部管理界面     |

---

✅ **总结**

* 调度中心负责 **任务调度、状态记录、监控**。
* 执行微服务负责 **任务执行、结果回传**。
* 分布式高可用由 **Quartz 集群 + 执行微服务水平扩展**保证。
* 系统支持多类型任务调度、幂等执行、失败重试和可视化监控。
* 整个设计实现了 **调度与执行解耦**，便于研发、运维和扩展。
